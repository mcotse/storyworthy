#!/bin/sh
# Pre-commit hook for Storyworthy app
# Bumps patch version, runs TypeScript check and unit tests

# Add bun to PATH if not present
export PATH="$HOME/.bun/bin:$PATH"

echo "Running pre-commit checks..."

# Bump patch version
echo "Bumping version..."
PACKAGE_JSON="package.json"
if [ -f "$PACKAGE_JSON" ]; then
  # Extract current version
  CURRENT_VERSION=$(grep '"version"' "$PACKAGE_JSON" | sed 's/.*"version": "\([^"]*\)".*/\1/')

  # Split into major.minor.patch
  MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
  MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
  PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)

  # Increment patch
  NEW_PATCH=$((PATCH + 1))
  NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

  # Update package.json
  sed -i '' "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" "$PACKAGE_JSON"

  # Stage the updated package.json
  git add "$PACKAGE_JSON"

  echo "  Version: $CURRENT_VERSION â†’ $NEW_VERSION"
fi

# Run TypeScript type check
echo "Checking types..."
if ! bun run build 2>&1 | grep -q "error"; then
  :
else
  bun run build 2>&1 | grep -A2 "error"
  echo "Type check failed. Please fix errors before committing."
  exit 1
fi

# Run unit tests
echo "Running unit tests..."
bun run test:run 2>&1
if [ $? -ne 0 ]; then
  echo "Tests failed. Please fix failing tests before committing."
  exit 1
fi

echo "Pre-commit checks passed!"
